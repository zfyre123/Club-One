window.GFSquare=null,function(g){GFSquare=function(e){for(var r in e)e.hasOwnProperty(r)&&(this[r]=e[r]);this.form=null,this.activeFeed=null,this.GFSCField=null,this.sqForm=null,this.nonce=null,this.init=function(){var i=this,n=null,s=!1;this.form=g("#gform_"+this.formId),this.GFSCField=g("#input_"+this.formId+"_"+this.ccFieldId+"_1"),gform.addAction("gform_frontend_feeds_evaluated",function(e,r){if(r===i.formId){n=null,s=!1;for(var t=Object.keys(e).length,a=0;a<t;a++)if("gravityformssquare"===e[a].addonSlug&&e[a].isActivated){s=!0,n=i.feeds[e[a].feedId],i.activeFeed=n,i.isCreditCardOnPage()&&(i.displaySquareCardError(""),i.resetSquareStatus(this.form,this.formId),i.createPaymentForm(i.GFSCField,i.application_id,i.location_id));break}s||(i.displaySquareCardError(gforms_square_frontend_strings.no_active_frontend_feed),i.resetSquareStatus(i.form,r),i.resetFormStatus(i.form,r,i.isLastPage()),null!==i.sqForm&&i.sqForm.destroy(),i.activeFeed=null)}}),g("#gform_"+this.formId).on("submit",function(e){if(i.GFSCField=g("#input_"+i.formId+"_"+i.ccFieldId+"_1"),s&&!g(this).data("gfsquaresubmitting")&&1!=g("#gform_save_"+i.formId).val()&&!gformIsHidden(i.GFSCField)&&i.isCreditCardOnPage()){e.preventDefault(),g(this).data("gfsquaresubmitting",!0),i.maybeAddSpinner(),i.form=g(this),"form_total"===n.paymentAmount&&(gform.addFilter("gform_product_total",function(e,r){return window["gform_square_amount_"+r]=e},51),gformCalculateTotalPrice(i.formId)),i.updatePaymentAmount();var r=parseInt(g("#gform_source_page_number_"+i.formId).val(),10),t=parseInt(g("#gform_target_page_number_"+i.formId).val(),10),a=!1;(t<r&&0!==t||0===window["gform_square_amount_"+i.formId])&&(a=!0),i.isLastPage()&&!i.isCreditCardOnPage()||gformIsHidden(i.GFSCField)||a?g(this).submit():"product"===n.type&&(null===i.nonce?i.sqForm.requestCardNonce():i.startSCA(i.nonce))}})},this.createPaymentForm=function(e,r,t){var n=this;n.sqForm=null,n.sqForm=new SqPaymentForm({applicationId:r,locationId:t,card:{elementId:e.attr("id"),inputStyle:n.cardStyle},callbacks:{cardNonceResponseReceived:function(e,r,t,a,i){n.nonceReceived(e,r,t,a,i)},paymentFormLoaded:function(){},inputEventReceived:function(e){switch(e.eventType){case"focusClassAdded":n.GFSCField.addClass("SqPaymentForm--focus");break;case"focusClassRemoved":n.GFSCField.removeClass("SqPaymentForm--focus");break;case"errorClassAdded":n.GFSCField.addClass("SqPaymentForm--invalid");break;case"errorClassRemoved":n.GFSCField.removeClass("SqPaymentForm--invalid")}}}}),n.sqForm.build()},this.nonceReceived=function(e,r,t,a,i){var n=this.form,s=this;if(e){for(var o="",d=0;d<e.length;d++)o+="<li> "+s.getLocalizedErrorMessage(e[d])+" </li>";return s.displaySquareCardError(o),s.resetSquareStatus(n,this.formId),s.resetFormStatus(n,this.formId,this.isLastPage()),!1}s.GFSCField.next(".validation_message").html(""),n.append(g('<input type="hidden" name="square_credit_card_last_four" id="'+this.formId+'_square_credit_card_last_four" />').val(t.last_4)),n.append(g('<input type="hidden" name="square_credit_card_type" id="'+this.formId+'_square_credit_card_type"/>').val(t.card_brand)),s.nonce=s.forceSCA?"cnon:card-nonce-requires-verification":r,n.append(g('<input type="hidden" name="square_nonce" id="'+this.formId+'_square_nonce" />').val(s.nonce)),s.startSCA(s.nonce)},this.startSCA=function(e){var t=this.form,r=this.activeFeed,a=this,i=g("#input_"+a.formId+"_"+a.ccFieldId+"_3").val().trim().split(" ");if(i.length<2)return a.displaySquareCardError(gforms_square_frontend_strings.requires_name,!0),a.resetFormStatus(g(this),a.formId,a.isLastPage()),!1;var n=i[0],s=i[1],o=GFMergeTag.replaceMergeTags(a.formId,a.getBillingAddressMergeTag(r.email)),d=GFMergeTag.replaceMergeTags(a.formId,a.getBillingAddressMergeTag(r.address_city)),m=GFMergeTag.replaceMergeTags(a.formId,a.getBillingAddressMergeTag(r.address_zip)),u=GFMergeTag.replaceMergeTags(a.formId,a.getBillingAddressMergeTag(r.address_line1));if(""===n||""===s)return!1;var f={intent:"CHARGE",amount:window["gform_square_amount_"+a.formId].toString(),currencyCode:a.currency,billingContact:{givenName:n,familyName:s,email:o,city:d,postalCode:m,addressLines:[u]}};a.sqForm.verifyBuyer(e,f,function(e,r){if(e)return a.displaySquareCardError(gforms_square_frontend_strings.sca),a.resetFormStatus(t,a.formId,a.isLastPage()),!1;a.GFSCField.next(".validation_message").html(""),t.append(g('<input type="hidden" name="square_verification" id="'+a.formId+'_square_verification" />').val(r.token)),t.submit()})},this.getLocalizedErrorMessage=function(e){var r="";return(r="VALIDATION_ERROR"===e.type?e.field:e.type)in gforms_square_frontend_strings?gforms_square_frontend_strings[r]:e.message},this.getBillingAddressMergeTag=function(e){return""===e?"":"{:"+e+":value}"},this.isLastPage=function(){var e=g("#gform_target_page_number_"+this.formId);return!(0<e.length)||0==e.val()},this.isCreditCardOnPage=function(){var e=this.getCurrentPageNumber();return!this.ccPage||!e||this.ccPage==e},this.getCurrentPageNumber=function(){var e=g("#gform_source_page_number_"+this.formId);return 0<e.length&&e.val()},this.maybeAddSpinner=function(){if(!this.isAjax)if("function"==typeof gformAddSpinner)gformAddSpinner(this.formId);else{var e=this.formId;if(0==jQuery("#gform_ajax_spinner_"+e).length){var r=gform.applyFilters("gform_spinner_url",gf_global.spinnerUrl,e);gform.applyFilters("gform_spinner_target_elem",jQuery("#gform_submit_button_"+e+", #gform_wrapper_"+e+" .gform_next_button, #gform_send_resume_link_button_"+e),e).after('<img id="gform_ajax_spinner_'+e+'"  class="gform_ajax_spinner" src="'+r+'" alt="" />')}}},this.resetSquareStatus=function(e,r){g("#"+r+"_square_nonce, #"+r+"_square_credit_card_last_four, #"+r+"_square_credit_card_type, #"+r+"_square_verification").remove()},this.resetFormStatus=function(e,r,t){e.data("gfsquaresubmitting",!1),g("#gform_ajax_spinner_"+r).remove(),t&&(window["gf_submitting_"+r]=!1)},this.displaySquareCardError=function(e,r){var t=null;(t=g(r?"#input_"+this.formId+"_"+this.ccFieldId+"_3":"#input_"+this.formId+"_"+this.ccFieldId+"_1")).next(".validation_message").length||t.after('<div class="gfield_description validation_message"></div>');var a=t.next(".validation_message");e?(a.html(e),0<g("#gform_ajax_spinner_"+this.formId).length&&g("#gform_ajax_spinner_"+this.formId).remove()):a.html("")},this.updatePaymentAmount=function(){var e=this.formId,r=this.activeFeed;if("form_total"!==r.paymentAmount){var t=GFMergeTag.getMergeTagValue(e,r.paymentAmount,":price"),a=GFMergeTag.getMergeTagValue(e,r.paymentAmount,":qty");"string"==typeof t&&(t=GFMergeTag.getMergeTagValue(e,r.paymentAmount+".2",":price"),a=GFMergeTag.getMergeTagValue(e,r.paymentAmount+".3",":qty")),window["gform_square_amount_"+e]=t*a}},this.init()}}(jQuery);